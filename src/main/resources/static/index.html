<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="bower_components/angular/angular.min.js"></script>
    <script src="bower_components/moment/min/moment.min.js"></script>
    <link href="bower_components/vis/dist/vis.css" rel="stylesheet" type="text/css" />
    <script src="bower_components/vis/dist/vis.min.js"></script>
    <script src="bower_components/angular-visjs/angular-vis.js"></script>
    <style type="text/css">
        .red {
          fill: red;
          font-size: 150%;
        }
        .normal {
          font-size: 150%;
        }
        body{
            width: 90vw;
            margin: 0 auto;
        }
    </style>

</head>
<body ng-app="weightApp" ng-controller="weightCtrl">

<vis-graph2d data="data" options="options"></vis-graph2d>


<script>
            var app = angular.module('weightApp', ['ngVis']);
            app.controller('weightCtrl', function($scope, $http, VisDataSet, $location) {

            var url = "weight" + window.location.href.substring(window.location.href.indexOf('?'));

            $http.get(url).then(function(data){
                console.log("sucesso");
                console.log(data);
                var names = ['Morning', 'Evening', 'Night'];
                var groups = new vis.DataSet();
                    groups.add({
                        id: 0,
                        content: names[0],
                        options: {
                            drawPoints: {
                                style: 'square' // square, circle
                            }
                        }});

                    groups.add({
                        id: 1,
                        content: names[1],
                        options: {
                            drawPoints: {
                                style: 'circle' // square, circle
                            }
                        }});

                    groups.add({
                        id: 2,
                        content: names[2],
                        options: {
                            drawPoints: {
                                style: 'circle' // square, circle
                            }
                        }});



                    var items = [];

                    var lastValue = 0;

                    data.data.reverse().forEach(function(item, index){
                        console.log(item);

                        var utcOffset = 0;
                        if(getUrlParameter('utcOffset')){
                            utcOffset = getUrlParameter('utcOffset');
                        }

                        var today = new Date((item.weightDateTime.epochSecond * 1000) + (Number(utcOffset) * 60 * 60 * 1000));
                        var dd = today.getDate();
                        var mm = today.getMonth()+1; //January is 0!
                        var yyyy = today.getFullYear();

                        if(dd<10) {
                            dd = '0'+dd
                        }

                        if(mm<10) {
                            mm = '0'+mm
                        }

                       // today = yyyy + '-' + mm + '-' + dd;

                        var period = 0;
                         if (today.getHours() >= 12){
                             if (today.getHours() >= 18){
                                period = 2
                             } else {
                                period = 1
                             }

                         }

                        console.log(today + " " + today.getHours() + " " + period );


                        var cssclass = "normal";
                        if(Number(item.value) > lastValue){
                            cssclass = "red";
                        }

                        items.push({x: today, y: item.value, group: period, label: {content:item.value,  xOffset: -65, className: cssclass}});

                        lastValue = item.value;
                    })

                    $scope.data = {items: new vis.DataSet(items), groups: groups};
                    $scope.options = {
                        dataAxis: {showMinorLabels: true}  ,
                        legend: {left:{position:"bottom-left"}}/*,
                        start: '2014-06-09',
                        end: '2014-07-03'
                        */
                    };

            }, function(error){
                console.log("ERROR");
                console.log(error);
            });

            function getUrlParameter(param, dummyPath) {
                    var sPageURL = dummyPath || window.location.search.substring(1),
                        sURLVariables = sPageURL.split(/[&||?]/),
                        res;

                    for (var i = 0; i < sURLVariables.length; i += 1) {
                        var paramName = sURLVariables[i],
                            sParameterName = (paramName || '').split('=');

                        if (sParameterName[0] === param) {
                            res = sParameterName[1];
                        }
                    }

                    return res;
            }




            });
        </script>
</body>
</html>
